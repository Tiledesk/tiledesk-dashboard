<h1 mat-dialog-title> 
  
   {{ 'WhatsAppBroadcasts' | translate}} 
</h1>

<!-- Loading state: show nothing or a loading indicator while checking -->
<div *ngIf="wa_is_installed === null" mat-dialog-content>
  <div class="wa-loading-container">
    <div class="wa-loading-text">{{ 'Loading' | translate }}...</div>
  </div>
</div>

<div *ngIf="wa_is_installed === false"  mat-dialog-content> 

  <div class="wa-not-installed-title">
    {{'WhatsAppNotConfigured' | translate}}
  </div>

  <div class="wa-not-installed-desc-wpr"> 

      <div class="wa-not-installed-desc">
          {{'UnableToCreateBroadcastWAIsNotInstalled'| translate}}
      </div>
    
  </div>



</div>

<div *ngIf="wa_is_installed === true"  mat-dialog-content> 
  <div class="contacts-wa-broadcast-modal-container">
    
    <div class="b-flex-container">
      
      <div class="b-left-columns-container">
        
        <div class="b-left--columns">
          
          <div class="choose-wa-tmplt-label-and-select-wpr">
            <div class="template-select-label">{{ 'ChooseTemplate' | translate }}</div>
            
            <div class="select-and-btn-wpr">
              <ng-select id="template-select" class="select-wa-template custom-panel-height"
                appendTo="body"  
                [clearable]="false" 
                [searchable]="false"
                [(ngModel)]="templateName" 
                [items]="templates_list" 
                bindLabel="name"
                bindValue="name" 
                placeholder="{{ 'ChooseTemplate' | translate }}" 
                style="width: 250px;"
                (change)="onSelectTemplate()">
              </ng-select>
            </div>
          </div>

          <!-- All Parameters in one section -->
          <div class="template-params-input-wpr">
            
            <!-- Phone Number - Always visible -->
            <div class="params-section-title" style="margin-top: 0px;">Phone number</div>
            <div class="params-container">
              <div class="param-input-wpr">
                <div class="param-label-container">
                  <i class="material-icons-outlined param-phone-icon">phone</i>
                </div>
                <div class="param-input-container">
                  <!-- form-control input-md  -->
                  <input 
                    type="text" 
                    class="param-input"
                    [(ngModel)]="phoneNumber"
                    placeholder="+1555123456"
                    style="width: 100%;">
                  <!-- <div class="param-input-icons">
                    <i class="material-icons-outlined param-icon">info_outline</i>
                    <i class="material-icons-outlined param-icon">code</i>
                  </div> -->
                </div>
              </div>
            </div>

            <!-- Header Parameters - IMAGE -->
            <div *ngIf="selected_template && headerParamsValues.length > 0 && header_component?.format === 'IMAGE'">
              <div class="params-section-title">Header parameters</div>
              <div class="params-section-description">
                The header contains an image to customize
              </div>
              <div class="params-container">
                <div class="param-input-wpr" *ngFor="let param of headerParamsValues; let i = index; trackBy: trackByIndex">
                  <div class="param-label-container">
                    <span class="param-number-badge">{{ i + 1 }}</span>
                  </div>
                  <div class="param-input-container">
                    <input 
                      type="text" 
                      class="input-md param-input"
                      [ngModel]="headerParamsValues[i]" 
                      (ngModelChange)="headerParamsValues[i] = $event; onHeaderParamChange()"
                      placeholder="Insert a valid image URL or upload a file"
                      style="width: 100%;">
                  </div>
                  <div class="param-action-button">
                    <button type="button" 
                            class="btn-param-action btn-param-clear" 
                            *ngIf="headerParamsValues[i]"
                            (click)="clearHeaderParam(i)"
                            title="Clear">
                      <i class="material-icons-outlined">close</i>
                    </button>
                    <button type="button" 
                            class="btn-param-action btn-param-upload" 
                            *ngIf="!headerParamsValues[i]"
                            (click)="triggerFileUpload(i, 'image')"
                            title="Upload image">
                      <i class="material-icons-outlined">cloud_upload</i>
                    </button>
                    <input 
                      type="file" 
                      [id]="'imageUploadInput_' + i"
                      accept="image/*"
                      style="display: none;"
                      (change)="onFileSelected($event, i, 'image')">
                  </div>
                </div>
              </div>
            </div>

            <!-- Header Parameters - DOCUMENT -->
            <div *ngIf="selected_template && headerParamsValues.length > 0 && header_component?.format === 'DOCUMENT'">
              <div class="params-section-title">Header parameters</div>
              <div class="params-section-description">
                The header contains a document to customize
              </div>
              <div class="params-container">
                <div class="param-input-wpr" *ngFor="let param of headerParamsValues; let i = index; trackBy: trackByIndex">
                  <div class="param-label-container">
                    <span class="param-number-badge">{{ i + 1 }}</span>
                  </div>
                  <div class="param-input-container">
                    <input 
                      type="text" 
                      class="input-md param-input"
                      [ngModel]="headerParamsValues[i]" 
                      (ngModelChange)="headerParamsValues[i] = $event; onHeaderParamChange()"
                      placeholder="Insert a valid document URL or upload a file"
                      style="width: 100%;">
                  </div>
                  <div class="param-action-button">
                    <button type="button" 
                            class="btn-param-action btn-param-clear" 
                            *ngIf="headerParamsValues[i]"
                            (click)="clearHeaderParam(i)"
                            title="Clear">
                      <i class="material-icons-outlined">close</i>
                    </button>
                    <button type="button" 
                            class="btn-param-action btn-param-upload" 
                            *ngIf="!headerParamsValues[i]"
                            (click)="triggerFileUpload(i, 'document')"
                            title="Upload document">
                      <i class="material-icons-outlined">cloud_upload</i>
                    </button>
                    <input 
                      type="file" 
                      [id]="'documentUploadInput_' + i"
                      accept=".pdf"
                      style="display: none;"
                      (change)="onFileSelected($event, i, 'document')">
                  </div>
                </div>
              </div>
            </div>

            <!-- Header Parameters - TEXT -->
            <div *ngIf="selected_template && headerParamsValues.length > 0 && header_component?.format === 'TEXT'">
              <div class="params-section-title">Header parameters</div>
              <div class="params-container">
                <div class="param-input-wpr" *ngFor="let param of headerParamsValues; let i = index; trackBy: trackByIndex">
                  <div class="param-label-container">
                    <span class="param-number-badge">{{ i + 1 }}</span>
                  </div>
                  <div class="param-input-container">
                    <input 
                      type="text" 
                      class="input-md param-input"
                      [ngModel]="headerParamsValues[i]" 
                      (ngModelChange)="headerParamsValues[i] = $event; onHeaderParamChange()"
                      [placeholder]="'{{' + (i + 1) + '}}'"
                      style="width: 100%;">
                  </div>
                </div>
              </div>
            </div>

            <!-- Body Parameters -->
            <div *ngIf="selected_template && bodyParamsValues.length > 0">
              <div class="params-section-title">Body parameters</div>
              <div class="params-container">
                <div class="param-input-wpr" *ngFor="let param of bodyParamsValues; let i = index; trackBy: trackByIndex">
                  <div class="param-label-container">
                    <span class="param-number-badge">{{ i + 1 }}</span>
                  </div>
                  <div class="param-input-container">
                    <!-- form-control -->
                    <input 
                      type="text" 
                      class=" input-md param-input"
                      [ngModel]="bodyParamsValues[i]" 
                      (ngModelChange)="bodyParamsValues[i] = $event; onBodyParamChange()"
                      [placeholder]="'{{' + (i + 1) + '}}'"
                      style="width: 100%;">
                  </div>
                </div>
              </div>
            </div>

            <!-- Button Parameters -->
            <div *ngIf="selected_template && buttonParamsValues.length > 0">
              <div class="params-section-title">Buttons parameters</div>
              <div class="params-container">
                <div class="param-input-wpr" *ngFor="let param of buttonParamsValues; let i = index; trackBy: trackByIndex">
                  <div class="param-label-container">
                    <span class="param-number-badge">{{ i + 1 }}</span>
                  </div>
                  <div class="param-input-container">
                    <!-- form-control -->
                    <input 
                      type="text" 
                      class=" input-md param-input"
                      [ngModel]="buttonParamsValues[i]" 
                      (ngModelChange)="buttonParamsValues[i] = $event; onButtonParamChange()"
                      placeholder="Insert a valid URL"
                      style="width: 100%;">
                  </div>
                </div>
              </div>
            </div>

          </div>
          
        </div>
      </div>
      
      <!-- -------------------------------------------------- -->
      <!-- Template Preview -->
      <!-- -------------------------------------------------- -->
      <div class="b-right-column">
        <div class="preview-template-header">
          {{ 'TemplatePreview' | translate }}
        </div>
        
        <div class="no-template-selected-container" *ngIf="!selected_template">
          <div class="no-template-selected">
            {{ 'NoTemplateSelected' | translate }}
          </div>
        </div>
        
        <div id="preview-container" class="preview-container" *ngIf="selected_template">
          <div class="inner-preview-container">
            <div class="message-cloud">
              
              <!-- // Header -->
              <div class="header-preview">
                <span *ngIf="header_component?.format === 'TEXT'"
                  [innerHTML]="header_component?.text | htmlEntitiesEncode | waToMarkdown | marked | formatParamBadges">
                </span>
                
                <span *ngIf="header_component?.format === 'IMAGE' && headerParamsValues[0]">
                  <img [src]="headerParamsValues[0]"
                    (error)="onHeaderImageError($event)" />
                </span>
                
                <span *ngIf="header_component?.format === 'DOCUMENT' && headerParamsValues[0]">
                  <div class="pdf-preview">
                    <p>PDF</p>
                  </div>
                </span>
                
                <span *ngIf="header_component?.format === 'LOCATION'">
                  <div class="location-preview">
                    {{ 'Location' | translate }}
                  </div>
                </span>
              </div>
              
              <!-- Body -->
              <div class="body-preview">
                <span [innerHTML]="body_component?.text | waToMarkdown | marked | formatParamBadges"></span>
              </div>
              
              <!-- // Footer -->
              <div class="footer-preview">
                <span [innerHTML]="footer_component?.text | htmlEntitiesEncode | waToMarkdown | marked"></span>
              </div>
              
              <!-- // Call to action preview -->
              <div *ngIf="buttons_component && (buttons_component.buttons[0].type === 'URL' || buttons_component.buttons[0].type === 'PHONE_NUMBER')"
                class="call-to-action-preview">
                
                <button *ngFor="let btn of buttons_component.buttons"
                  class="btn whatsapp-call-to-action">
                  <span *ngIf="btn.type === 'URL'"
                    class="material-icons-outlined call-to-action-icon">open_in_new</span>
                  <span *ngIf="btn.type === 'PHONE_NUMBER'"
                    class="material-icons-round call-to-action-icon">phone</span>
                  <span [innerHTML]="btn.text | htmlEntitiesEncode | formatParamBadges"></span>
                </button>
              </div>
              
            </div>
            
            <div class="message-cloud-buttons-container"
              *ngIf="buttons_component && buttons_component.buttons[0].type === 'QUICK_REPLY'">
              <div class="message-cloud-buttons">
                <button *ngFor="let btn of buttons_component.buttons" fill="clear"
                  class="message-cloud-button">
                  <span class="_2VWlB">{{btn.text}}</span>
                </button>
              </div>
            </div>
            
          </div>
        </div>
        <!-- ./ preview -->
      </div>
    </div>
  </div>



</div>
<div *ngIf="wa_is_installed === true" mat-dialog-actions style="justify-content: center;">
    <button class="mat-dialog-close-btn" mat-button (click)="onNoClick()">
        {{ "Cancel" | translate }}
       
    </button>

    <button [disabled]="!selected_template" class="mat-dialog-ok-btn" mat-button
        (click)="onOkPresssed()" cdkFocusInitial>
        
          {{'StartBroadcast' | translate}}
        
    </button>
</div>

<div *ngIf="wa_is_installed === false" mat-dialog-actions style="justify-content: center;">
    <button class="mat-dialog-close-btn" mat-button (click)="onNoClick()">
        {{ "Cancel" | translate }}
       
    </button>

    <button class="mat-dialog-ok-btn" mat-button
        (click)="onConfigureWAPresssed()" cdkFocusInitial>
        
          {{'OnboardPage.Configure' | translate}}
        
    </button>
</div>
